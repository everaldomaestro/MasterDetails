@model MasterDetails.Models.Master

@{
    ViewData["Title"] = "Create";
    var itens = 0;
    if (Model != null)
    {
        if (Model.Details != null)
        {
            itens = Model.Details.Count();
        }
    }
}

<h1>Create</h1>

<h4>Master</h4>
<hr />
<form id="master" asp-action="Create">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="form-group">
        <label asp-for="Data" class="control-label"></label>
        <input asp-for="Data" class="form-control" />
        <span asp-validation-for="Data" class="text-danger"></span>
    </div>

    <div class="row">
        <div class="form-group col-12 col-md-6 align-self-start">
            <label for="ProdutoId">Produto</label>
            <select class="form-control" id="ProdutoId" asp-items="ViewBag.Produtos">
                <option value=""></option>
            </select>
        </div>
        <div class="form-group col-12 col-md-6 align-self-end">
            <button type="button" class="btn btn-secondary btn-adicionar-produto float-md-right">Adicionar Produto</button>
        </div>
        <span asp-validation-for="Details" class="text-danger ml-3"></span>
    </div>
    <br />
    <table class="table">
        <thead>
            <tr>
                <th>Produto</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="table-produto">
            @if (Model != null)
            {
                if (Model.Details != null)
                {
                    @for (int i = 0; i < Model.Details.Count(); i++)
                    {
                        <tr>
                            <td>
                                <input type="text" asp-for="Details[i].ProdutoId" class="form-control produtosIds" />
                                @Model.Details[i].Produto.Nome
                            </td>
                        </tr>
                    }
                }
            }
        </tbody>
    </table>

    <div class="form-group">
        <input type="submit" value="Salvar" class="btn btn-primary" />
    </div>
</form>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        var tabelaProduto = $('#table-produto-base').html();
        var itens = @itens;

        function adicionarProduto() {
            var produtoId = $('#ProdutoId').val();
            var table = $('#table-produto');

            if (produtoId != null && produtoId > 0) {
                $.ajax({
                    url: "@Url.Action("AppendProdutos")",
                    data: { produtoId },
                    success: function (produto) {
                        table.append("<tr id='tabela-produto-linha-" + itens + "'><td><input type='hidden' class='form-control produtosIds' id='Details[" + itens + "].ProdutoId' name='Details[" + itens + "].ProdutoId' value='" + produto.produtoId + "' />" + produto.nome + "</td><td><button type='button' class='btn btn-danger btn-rm-produto' onclick='removerProduto(" + itens + ")'>Remover Produto</button></td></tr>");
                        itens++;
                    }
                })
            }
            else {
                alert('Selecione o produto');
            }
        }

        function removerProduto(index) {
            var array = [];
            $(".produtosIds").each(function () {
                var detail = { DetailId: 0, MasterId: 0, ProdutoId : this.value };
                array.push(detail);
            });

            var details = JSON.stringify({ 'details': array });

            console.log(details);

            $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: "@Url.Action("RemoveProdutos")",
                data: { index, details},
                success: function (details) {
                    console.log(details);
                }
            })
        }

        $('.btn-adicionar-produto').on('click', adicionarProduto);
    </script>
}
